<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inlet Telemetry - Google Maps</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 280px;
        }
        .info-panel h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #1a73e8;
        }
        .status {
            font-size: 14px;
            color: #5f6368;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            max-width: 400px;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #d93025;
            padding: 20px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>Loading inlet data...</div>
    </div>
    <div id="map"></div>
    <div class="info-panel">
        <h3>üö∞ Inlet Telemetry</h3>
        <div class="status" id="status">Connecting...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://lvmubwveixffneafbfjt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2bXVid3ZlaXhmZm5lYWZiZmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzAzMDYsImV4cCI6MjA4NDAwNjMwNn0.-3OJ890CHIXUQ6nU-RpsYOCUNGTw-QMQjzZd8VUFS8A';
        
        // Initialize Supabase client (only if not already initialized)
        let supabaseClient;
        if (typeof window.supabaseClient === 'undefined') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabaseClient = supabaseClient;
        } else {
            supabaseClient = window.supabaseClient;
        }
        
        let map;
        let markers = [];
        let infoWindow;
        
        // Initialize Google Map
        function initMap() {
            console.log('Initializing Google Map...');
            // Create map centered at a default location
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 2,
                center: { lat: 0, lng: 0 },
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            infoWindow = new google.maps.InfoWindow();
            
            // Load inlet data
            loadInletData();
        }
        
        // Fetch and display inlet data
        async function loadInletData() {
            try {
                console.log('Attempting to fetch data from Supabase...');
                console.log('Table: tblInlets');
                
                const { data, error } = await supabaseClient
                    .from('tblInlets')
                    .select('*');
                
                console.log('Supabase response:', { data, error });
                
                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }
                
                document.getElementById('loading').style.display = 'none';
                
                if (!data || data.length === 0) {
                    document.getElementById('status').innerHTML = '<span style="color: #f29900;">‚ö†Ô∏è No inlet data found</span>';
                    console.warn('No data returned from Supabase');
                    return;
                }
                
                console.log(`Successfully loaded ${data.length} inlets`);
                console.log('First inlet sample:', data[0]);
                
                document.getElementById('status').innerHTML = `<span style="color: #1e8e3e;">‚úì ${data.length} inlets loaded</span>`;
                
                // Create bounds to fit all markers
                const bounds = new google.maps.LatLngBounds();
                let validMarkerCount = 0;
                
                // Add markers for each inlet
                data.forEach((inlet, index) => {
                    // Try multiple coordinate field combinations
                    let lat, lng;
                    
                    if (inlet.Latitude && inlet.Longitude) {
                        lat = parseFloat(inlet.Latitude);
                        lng = parseFloat(inlet.Longitude);
                    } else if (inlet.y && inlet.x) {
                        lat = parseFloat(inlet.y);
                        lng = parseFloat(inlet.x);
                    } else if (inlet.YCOORD && inlet.XCOORD) {
                        lat = parseFloat(inlet.YCOORD);
                        lng = parseFloat(inlet.XCOORD);
                    }
                    
                    // Check if coordinates are valid
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        const position = { lat, lng };
                        validMarkerCount++;
                        
                        // Determine marker color based on status
                        let markerColor = '#1a73e8'; // Default blue
                        if (inlet.STATUS) {
                            const status = inlet.STATUS.toLowerCase();
                            if (status.includes('active')) markerColor = '#1e8e3e'; // Green
                            else if (status.includes('inactive')) markerColor = '#d93025'; // Red
                            else if (status.includes('maintenance')) markerColor = '#f29900'; // Orange
                        }
                        
                        // Create custom marker icon
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: inlet['Facility ID'] || `Inlet ${inlet.OBJECTID}`,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: markerColor,
                                fillOpacity: 0.9,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            },
                            animation: google.maps.Animation.DROP
                        });
                        
                        // Create info window content with all relevant fields
                        const contentString = `
                            <div style="font-family: 'Roboto', Arial, sans-serif; padding: 10px; max-width: 300px;">
                                <h3 style="margin: 0 0 10px 0; color: #1a73e8; font-size: 16px;">
                                    ${inlet['Facility ID'] || 'Inlet ' + inlet.OBJECTID}
                                </h3>
                                <div style="font-size: 13px; line-height: 1.6;">
                                    <p style="margin: 5px 0;"><strong>Object ID:</strong> ${inlet.OBJECTID || 'N/A'}</p>
                                    ${inlet.TYPE ? `<p style="margin: 5px 0;"><strong>Type:</strong> ${inlet.TYPE}</p>` : ''}
                                    ${inlet.STATUS ? `<p style="margin: 5px 0;"><strong>Status:</strong> ${inlet.STATUS}</p>` : ''}
                                    ${inlet['Service Area'] ? `<p style="margin: 5px 0;"><strong>Service Area:</strong> ${inlet['Service Area']}</p>` : ''}
                                    ${inlet.OWNERSHIP ? `<p style="margin: 5px 0;"><strong>Ownership:</strong> ${inlet.OWNERSHIP}</p>` : ''}
                                    ${inlet.TRASH_RACK ? `<p style="margin: 5px 0;"><strong>Trash Rack:</strong> ${inlet.TRASH_RACK}</p>` : ''}
                                    ${inlet.HEADWALL ? `<p style="margin: 5px 0;"><strong>Headwall:</strong> ${inlet.HEADWALL}</p>` : ''}
                                    ${inlet.DATE_BUILT ? `<p style="margin: 5px 0;"><strong>Date Built:</strong> ${inlet.DATE_BUILT}</p>` : ''}
                                    ${inlet['INVERT ELEVATION'] ? `<p style="margin: 5px 0;"><strong>Invert Elevation:</strong> ${inlet['INVERT ELEVATION']}</p>` : ''}
                                    <p style="margin: 5px 0;"><strong>Coordinates:</strong><br>
                                        Lat: ${lat.toFixed(6)}<br>
                                        Lng: ${lng.toFixed(6)}
                                    </p>
                                    ${inlet['EDIT DATE'] ? `<p style="margin: 5px 0; color: #666; font-size: 11px;"><strong>Last Edited:</strong> ${new Date(inlet['EDIT DATE']).toLocaleString()}</p>` : ''}
                                </div>
                            </div>
                        `;
                        
                        // Add click listener to show info window
                        marker.addListener('click', () => {
                            infoWindow.setContent(contentString);
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                        bounds.extend(position);
                    } else {
                        console.warn('Invalid coordinates for inlet:', inlet);
                    }
                });
                
                console.log(`Created ${validMarkerCount} valid markers out of ${data.length} inlets`);
                
                // Fit map to show all markers
                if (markers.length > 0) {
                    map.fitBounds(bounds);
                    
                    // Adjust zoom if only one marker
                    if (markers.length === 1) {
                        map.setZoom(15);
                    }
                } else {
                    document.getElementById('status').innerHTML = '<span style="color: #f29900;">‚ö†Ô∏è No valid coordinates found</span>';
                }
                
            } catch (error) {
                console.error('Error loading inlet data:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                
                let errorMessage = error.message;
                let helpText = '';
                
                // Provide specific help based on error type
                if (error.message && error.message.includes('JWT')) {
                    helpText = 'API key issue - check your Supabase anon key';
                } else if (error.message && error.message.includes('permission')) {
                    helpText = 'Permission denied - Row Level Security (RLS) may be blocking access';
                } else if (error.code === '42P01') {
                    helpText = 'Table not found - check table name is exactly "tblInlets"';
                }
                
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <strong>‚ö†Ô∏è Error loading data</strong><br><br>
                        <strong>Error:</strong> ${errorMessage}<br>
                        ${helpText ? `<br><strong>Likely cause:</strong> ${helpText}<br>` : ''}
                        <br>
                        <small><strong>Check console for full details</strong></small><br><br>
                        <small>Common fixes:</small><br>
                        <small>‚Ä¢ Enable public SELECT access in RLS policies</small><br>
                        <small>‚Ä¢ Verify table name is "tblInlets"</small><br>
                        <small>‚Ä¢ Check API key is correct</small>
                    </div>
                `;
                document.getElementById('status').innerHTML = '<span style="color: #d93025;">‚úó Error loading data</span>';
            }
        }
        
        // Clear all markers
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }
        
        // Set up real-time updates
        supabaseClient
            .channel('inlet-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'tblInlets' },
                (payload) => {
                    console.log('Change received!', payload);
                    // Reload data when changes occur
                    clearMarkers();
                    loadInletData();
                }
            )
            .subscribe();
    </script>
    
    <!-- Load Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4A8tjVu0YBXBxMAwqp-i9PukDUGKLQrg&callback=initMap" async defer></script>
</body>
</html>
