<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inlet Telemetry Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 280px;
        }
        .info-panel h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #1a73e8;
        }
        .status {
            font-size: 14px;
            color: #5f6368;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #d93025;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>Loading inlet data...</div>
    </div>
    <div id="map"></div>
    <div class="info-panel">
        <h3>üö∞ Inlet Telemetry</h3>
        <div class="status" id="status">Connecting...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://lvmubwveixffneafbfjt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2bXVid3ZlaXhmZm5lYWZiZmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzAzMDYsImV4cCI6MjA4NDAwNjMwNn0.-3OJ890CHIXUQ6nU-RpsYOCUNGTw-QMQjzZd8VUFS8A';
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Initialize map
        const map = L.map('map').setView([0, 0], 2);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        let markers = [];
        
        // Custom icon for inlets
        const createCustomIcon = (color) => {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${color};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [26, 26],
                iconAnchor: [13, 13],
                popupAnchor: [0, -13]
            });
        };
        
        // Fetch and display inlet data
        async function loadInletData() {
            try {
                console.log('Attempting to fetch data from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('tblInlets')
                    .select('*');
                
                console.log('Supabase response:', { data, error });
                
                if (error) {
                    throw error;
                }
                
                document.getElementById('loading').style.display = 'none';
                
                if (!data || data.length === 0) {
                    document.getElementById('status').innerHTML = '<span style="color: #f29900;">‚ö†Ô∏è No inlet data found</span>';
                    return;
                }
                
                console.log(`Successfully loaded ${data.length} inlets`);
                document.getElementById('status').innerHTML = `<span style="color: #1e8e3e;">‚úì ${data.length} inlets loaded</span>`;
                
                // Create a bounds object to fit all markers
                const bounds = L.latLngBounds();
                let validMarkerCount = 0;
                
                // Add markers for each inlet
                data.forEach(inlet => {
                    // Try multiple coordinate field combinations
                    let lat, lng;
                    
                    if (inlet.Latitude && inlet.Longitude) {
                        lat = parseFloat(inlet.Latitude);
                        lng = parseFloat(inlet.Longitude);
                    } else if (inlet.y && inlet.x) {
                        lat = parseFloat(inlet.y);
                        lng = parseFloat(inlet.x);
                    } else if (inlet.YCOORD && inlet.XCOORD) {
                        lat = parseFloat(inlet.YCOORD);
                        lng = parseFloat(inlet.XCOORD);
                    }
                    
                    // Check if coordinates are valid
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        validMarkerCount++;
                        
                        // Determine marker color based on status
                        let markerColor = '#1a73e8'; // Default blue
                        if (inlet.STATUS) {
                            const status = inlet.STATUS.toLowerCase();
                            if (status.includes('active')) markerColor = '#1e8e3e'; // Green
                            else if (status.includes('inactive')) markerColor = '#d93025'; // Red
                            else if (status.includes('maintenance')) markerColor = '#f29900'; // Orange
                        }
                        
                        const marker = L.marker([lat, lng], { 
                            icon: createCustomIcon(markerColor)
                        }).addTo(map);
                        
                        // Create popup content
                        const popupContent = `
                            <div style="font-family: 'Roboto', Arial, sans-serif; min-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: #1a73e8;">
                                    ${inlet['Facility ID'] || 'Inlet ' + inlet.OBJECTID}
                                </h4>
                                <div style="font-size: 12px; line-height: 1.6;">
                                    <p style="margin: 4px 0;"><strong>Object ID:</strong> ${inlet.OBJECTID || 'N/A'}</p>
                                    ${inlet.TYPE ? `<p style="margin: 4px 0;"><strong>Type:</strong> ${inlet.TYPE}</p>` : ''}
                                    ${inlet.STATUS ? `<p style="margin: 4px 0;"><strong>Status:</strong> ${inlet.STATUS}</p>` : ''}
                                    ${inlet['Service Area'] ? `<p style="margin: 4px 0;"><strong>Service Area:</strong> ${inlet['Service Area']}</p>` : ''}
                                    ${inlet.OWNERSHIP ? `<p style="margin: 4px 0;"><strong>Ownership:</strong> ${inlet.OWNERSHIP}</p>` : ''}
                                    ${inlet.TRASH_RACK ? `<p style="margin: 4px 0;"><strong>Trash Rack:</strong> ${inlet.TRASH_RACK}</p>` : ''}
                                    ${inlet.HEADWALL ? `<p style="margin: 4px 0;"><strong>Headwall:</strong> ${inlet.HEADWALL}</p>` : ''}
                                    ${inlet.DATE_BUILT ? `<p style="margin: 4px 0;"><strong>Date Built:</strong> ${inlet.DATE_BUILT}</p>` : ''}
                                    ${inlet['INVERT ELEVATION'] ? `<p style="margin: 4px 0;"><strong>Invert Elevation:</strong> ${inlet['INVERT ELEVATION']}</p>` : ''}
                                    <p style="margin: 4px 0;"><strong>Coordinates:</strong><br>
                                        ${lat.toFixed(6)}, ${lng.toFixed(6)}
                                    </p>
                                    ${inlet['EDIT DATE'] ? `<p style="margin: 4px 0; color: #666; font-size: 11px;"><strong>Last Edited:</strong> ${new Date(inlet['EDIT DATE']).toLocaleString()}</p>` : ''}
                                </div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        markers.push(marker);
                        bounds.extend([lat, lng]);
                    } else {
                        console.warn('Invalid coordinates for inlet:', inlet);
                    }
                });
                
                console.log(`Created ${validMarkerCount} valid markers out of ${data.length} inlets`);
                
                // Fit map to show all markers
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    document.getElementById('status').innerHTML = '<span style="color: #f29900;">‚ö†Ô∏è No valid coordinates found</span>';
                }
                
            } catch (error) {
                console.error('Error loading inlet data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <strong>‚ö†Ô∏è Error loading data</strong><br><br>
                        ${error.message}<br><br>
                        <small>Please check:</small><br>
                        <small>‚Ä¢ Supabase credentials</small><br>
                        <small>‚Ä¢ Table permissions (RLS)</small><br>
                        <small>‚Ä¢ Network connection</small>
                    </div>
                `;
                document.getElementById('status').innerHTML = '<span style="color: #d93025;">‚úó Error loading data</span>';
            }
        }
        
        // Set up real-time updates
        supabaseClient
            .channel('inlet-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'tblInlets' },
                (payload) => {
                    console.log('Change received!', payload);
                    // Reload data when changes occur
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    loadInletData();
                }
            )
            .subscribe();
        
        // Load data when page loads
        loadInletData();
    </script>
</body>
</html>
